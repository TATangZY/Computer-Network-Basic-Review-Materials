# 网络层

实现的是从主机到主机的通信

## 连接建立

### 虚电路网络

- 虚电路网络的组成

  源和目的主机之间的路径
  VC号，沿着该路径的每段链路的编号
  路径中每台路由器的转发表表项

	- VC号

	  路由器中有一个转发表，每个入VC号对应着一个出VC号。
	  好处：
	  减少了首部中VC字段的长度，如果不这样子设定，那么VC号将会非常长（每个VC号都要不同）
	  简化了虚电路的建立，如果每条虚电路的VC号都不相同，那么路由器将要处理大量的报文以约定一个相同的VC号用于一次连接

- 网络层连接和运输层连接的区别

  网络层上，一条连接中的所有路由器都知道经过他们的所有虚电路。
  而运输层上，只有两个端系统知道该连接，路由器对此毫不知情。

### 数据报网络

## 转发

指的是将一个分组从输入链路接口转移到输出链路接口的本地动作
每个路由器有一个转发表，路由器通过检查到达分组首部字段的值来转发分组

### 路由器工作原理

- 路由器组成

	- 输入端口

	  输入端口还要完成查找功能，通过查询转发表决定路由器的输出端口
	  必须出现物理层和链路层处理
	  必须检查分组的版本号，检验和以及寿命字段，并且重写后两个字段
	  必须更新用于网络管理的计数器，如IP数据包的个数等
	  有缓存结构
	  每个输入端口都有一个转发表的影子副本

	- 输出端口
	- 交换结构

		- 经内存交换

		  输入和输出端口就像传统的I/O设备一样。
		  不能同时转发两个分组，即使他们有不同的端口号

		- 经总线交换

		  通过一根共享总线将分组直接传送到输出端口，不需要路由处理器的干预

		- 经互联网络交换

	- 路由选择处理器

- 排队

  当交换速度比输入速度慢时，会在输入端口出现排队
  当输出速度比交换速度慢时，会在输出端口出现排队
  线头阻塞：排在队伍前面的分组阻塞其他分组向前移动

## 网络协议

### IP

- IP数据报格式

  版本
  首部长度，大部分为20字节
  服务类型
  数据报长度，一般很少超过1500字节
  标识，标志，片偏移
  寿命，限制了数据报在网络中的转发次数
  协议，指示了IP数据报的数据部分应交给哪个特定的运输层协议
  首部校验和。每台路由器上都要重新计算校验和并再次放到原处，因为TTL字段可能会变化
  源和目的IP地址
  选项
  数据

- 数据报分片

  一个链路层帧能承载的最大数据量叫做最大传送单元（MTU）包括IP首部
  最后一片的标志比特被设为0，使用偏移字段来确定该片应放在初始IP数据报的那一个位置
  每一片又拥有完整的IP首部
  分片在端系统合并

- IPv4 编址

	- CIDR

	  32bit 的 IP 地址被分为两个部分 a.b.c.d/x其中 x 指示了地址中第一部分的比特数（前缀）
	  其余的比特用来标识该组织内的主机

	- 获得地址快
	- 获得主机地址（DHCP）

	  允许一台主机得知其他信息，例如他的子网掩码，第一跳路由器地址（默认网关）和本地的DNS服务器地址
	  
	  被分为四步
	  DHCP 服务器发现；报文使用 UDP 协议。使用广播目的地址 255.255.255.255 并使用 0.0.0.0 作为原地址
	  DHCP 服务器提供；仍使用255.255.255.255 广播。提供的报文包含收到的发现报文的事物ID，向客户推荐的IP地址，网络掩码以及IP地址租用期
	  DHCP 请求；回显配置参数
	  DHCP ACK；证实所要求的参数

	- 网络地址转化（NAT）

	  具有专用地址的地域是指其地址仅对该网络中的设备有意义的网络。
	  NAT 能使路由器对于外部来说不像一台路由器。NAT路由器对外部的行为反过来就好像一个具有单一IP的单一设备
	  在NAT路由器上有一张NAT转换表，在表项中包含了端口号及其IP地址

- IPv6

### ICMP

被主机和路由器用来彼此沟通网络层的信息
ICMP报文是承载在IP分组中的

## 路由选择

指的是网络范围内的一个过程
路由选择算法决定了路由器转发表中的值

### 路由选择算法

- LS 算法

  LS 算法的具体步骤
  时间复杂度 最坏O(n^2)
  
  问题
  震荡

- DV 算法

  迭代，异步的。每一节点都要从直接了连接的邻居收集信息，计算，然后发给邻居。整个过程持续到邻居间没有信息要交换为止。
  
  每个节点 x 维护以下三个信息
  对于每个邻居v, 从x到直接相邻的邻居v的费用 c(x, v)
  节点x的距离向量，即x到N中所有目的地y的费用的估计值
  他的每个邻居的距离向量
  
  问题
  路由选择环路

	- Bellman-Ford 方程

	  方程的解为节点的转发表提供了表项
	  提出了将DV算法中发生的邻居到邻居间通信的形式

- 层次路由选择

  LS，DV 算法不适合在大规模的网络中使用，于是需要将路由器组织进自治系统来解决问题。

	- 自治系统 (AS)

	  同一 AS 中的路由器全部使用相同的路由选择算法

	- 自治系统间路由选择协议

	  如果有多个链路通往外部 AS 链路，那么为了决定该向哪个 AS 转发分组，就需要
	  知道经多个 AS 分别可以到达哪些目的地
	  向自己所在的 AS 中的路由器传播这些可达性信息

		- 热土豆路由选择

		  如果出口网关有多种选择，那么使用热土豆路由选择：
		  	AS 尽可能快地扔掉分组，在多个到网关的路径间选择一个最短的。

### 因特网中的路由选择

- RIP

  使用跳数作为费用测度，每条链路费用为1
  最大路径长度为15跳
  路由器在UDP上发送RIP报文
  节点间每30秒交换一次信息

- OSPF

  核心是一个使用洪泛链路状态信息的链路状态协议和一个最短路径算法
  不强制规定如何设置链路的权值
  OSPF报文直接由IP承载
  具有按层次结构构造一个自治系统的能力，每个区域内都运行自己的OSPF链路状态路由选择算法
